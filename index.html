<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Way-Pay HR Secure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }</style>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.303.0"
      }
    }
    </script>
</head>
<body> 
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { LogOut, PlusCircle, ShieldCheck } from 'lucide-react';
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- ⬇️ PASTE YOUR KEYS HERE ⬇️ ---
       const firebaseConfig = {
  apiKey: "AIzaSyCK4f5NiYZ4WAcErl1-Ts4J-Pit1abl748",
  authDomain: "hr-system-46e00.firebaseapp.com",
  projectId: "hr-system-46e00",
  storageBucket: "hr-system-46e00.firebasestorage.app",
  messagingSenderId: "868038807384",
  appId: "1:868038807384:web:6ece4c7400c7f7f72e5f2d",
  measurementId: "G-M74HXBGK63"
};
        // ----------------------------------

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        function App() {
            const [user, setUser] = useState(null);
            const [icInput, setIcInput] = useState("");
            const [password, setPassword] = useState("");
            const [leaves, setLeaves] = useState([]); 
            const [error, setError] = useState("");

            // 1. AUTH LISTENER
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        // Strip the fake domain to get real IC
                        const realIc = currentUser.email.replace('@waypay.hr', '');
                        loadUserData(realIc, currentUser.email);
                    }
                });
                return () => unsubscribe();
            }, []);

            // 2. LOAD DATA (Securely)
            const loadUserData = (ic, email) => {
                let q;
                if (email === "admin@waypay.hr") {
                    // Admin sees EVERYTHING
                    q = query(collection(db, "leaves"));
                } else {
                    // Employee sees ONLY their matching IC
                    q = query(collection(db, "leaves"), where("icNumber", "==", ic));
                }

                onSnapshot(q, (snapshot) => {
                    const loadedLeaves = snapshot.docs.map(doc => ({
                        id: doc.id, ...doc.data()
                    }));
                    setLeaves(loadedLeaves);
                }, (err) => {
                    console.error("Access Denied:", err);
                });
            };

            // 3. LOGIN (IC -> Email Translation)
            const handleLogin = async (e) => {
                e.preventDefault();
                try {
                    // We append the domain automatically
                    const systemEmail = icInput + "@waypay.hr"; 
                    await signInWithEmailAndPassword(auth, systemEmail, password);
                    setError("");
                } catch (err) {
                    setError("Login Failed: Check your IC or Password");
                }
            };

            // 4. SUBMIT CLAIM
            const handleSubmit = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const currentIc = user.email.replace('@waypay.hr', '');

                try {
                    await addDoc(collection(db, "leaves"), {
                        reason: formData.get("reason"),
                        date: formData.get("date"),
                        status: "Pending",
                        icNumber: currentIc, // Tagging the data with IC
                        createdAt: new Date()
                    });
                    e.target.reset(); 
                    alert("Claim Submitted Successfully");
                } catch (err) {
                    alert("Error: " + err.message);
                }
            };

            // --- UI ---
            if (!user) {
                return React.createElement('div', { className: "min-h-screen flex items-center justify-center bg-slate-100" },
                    React.createElement('div', { className: "bg-white p-8 rounded-lg shadow-xl w-96 border-t-4 border-blue-600" },
                        React.createElement('h1', { className: "text-2xl font-bold mb-2 text-center text-slate-800" }, "Way-Pay HR"),
                        React.createElement('p', { className: "text-center text-slate-500 mb-6 text-sm" }, "Secure Employee Login"),
                        error && React.createElement('div', { className: "bg-red-50 text-red-600 p-2 rounded mb-4 text-sm border border-red-200" }, error),
                        React.createElement('form', { onSubmit: handleLogin, className: "space-y-4" },
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-semibold text-slate-700" }, "IC Number"),
                                React.createElement('input', {
                                    type: "text",
                                    placeholder: "e.g. 900101075555",
                                    className: "w-full p-2 border rounded mt-1 focus:ring-2 focus:ring-blue-500 outline-none",
                                    value: icInput,
                                    onChange: (e) => setIcInput(e.target.value)
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: "block text-sm font-semibold text-slate-700" }, "Password"),
                                React.createElement('input', {
                                    type: "password",
                                    className: "w-full p-2 border rounded mt-1 focus:ring-2 focus:ring-blue-500 outline-none",
                                    value: password,
                                    onChange: (e) => setPassword(e.target.value)
                                })
                            ),
                            React.createElement('button', { type: "submit", className: "w-full bg-blue-600 text-white p-2 rounded font-medium hover:bg-blue-700 transition" }, "Secure Login")
                        )
                    )
                );
            }

            return React.createElement('div', { className: "min-h-screen bg-slate-50 p-4" },
                React.createElement('div', { className: "max-w-md mx-auto" },
                    // Header
                    React.createElement('div', { className: "flex justify-between items-center mb-6 bg-white p-4 rounded shadow-sm" },
                        React.createElement('div', { className: "flex items-center gap-2" },
                            React.createElement(ShieldCheck, { size: 20, className: "text-green-600" }),
                            React.createElement('span', { className: "font-bold text-slate-700" }, "ID: " + user.email.replace('@waypay.hr', ''))
                        ),
                        React.createElement('button', { onClick: () => signOut(auth), className: "text-red-600 text-sm font-medium hover:bg-red-50 px-3 py-1 rounded" }, "Logout")
                    ),

                    // Admin vs Employee View
                    user.email === "admin@waypay.hr" 
                    ? React.createElement('div', { className: "mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded text-yellow-800 text-sm" }, "Admin Mode: You can see all staff requests.")
                    : null,

                    // Submit Form
                    React.createElement('form', { onSubmit: handleSubmit, className: "bg-white p-5 rounded shadow mb-6" },
                        React.createElement('h3', { className: "font-bold mb-4 flex items-center gap-2 text-slate-800" }, 
                            React.createElement(PlusCircle, { size: 18, className: "text-blue-600" }), "New Leave Request"
                        ),
                        React.createElement('div', { className: "space-y-3" },
                            React.createElement('input', { name: "reason", placeholder: "Reason (e.g. Medical Leave)", className: "w-full p-2 border rounded bg-slate-50", required: true }),
                            React.createElement('input', { name: "date", type: "date", className: "w-full p-2 border rounded bg-slate-50", required: true }),
                            React.createElement('button', { className: "w-full bg-blue-600 text-white p-2 rounded font-medium hover:bg-blue-700" }, "Submit Request")
                        )
                    ),

                    // List
                    React.createElement('div', { className: "space-y-3" },
                        leaves.length === 0 
                        ? React.createElement('div', { className: "text-center text-slate-400 py-8" }, "No records found.") 
                        : leaves.map(leave => 
                            React.createElement('div', { key: leave.id, className: "bg-white p-4 rounded shadow-sm border-l-4 " + (leave.status === "Approved" ? "border-green-500" : "border-yellow-400") },
                                React.createElement('div', { className: "font-bold text-slate-800" }, leave.reason),
                                React.createElement('div', { className: "text-xs text-slate-500 flex justify-between mt-2 items-center" },
                                    React.createElement('span', null, "Date: " + leave.date),
                                    React.createElement('span', { className: "px-2 py-1 bg-slate-100 rounded text-slate-600 font-medium" }, leave.status)
                                ),
                                // Show IC tag if Admin
                                user.email === "admin@waypay.hr" && React.createElement('div', { className: "text-xs text-blue-600 mt-1 font-mono" }, "Staff ID: " + leave.icNumber)
                            )
                        )
                    )
                )
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
